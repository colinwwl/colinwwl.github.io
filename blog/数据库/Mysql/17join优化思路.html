<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>join优化以及条件解析 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b3aba94c.css" as="style"><link rel="preload" href="/blog/assets/js/app.402a9c30.js" as="script"><link rel="preload" href="/blog/assets/js/3.64b046d0.js" as="script"><link rel="preload" href="/blog/assets/js/166.984417c0.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.96001213.js"><link rel="prefetch" href="/blog/assets/js/100.056ffb3b.js"><link rel="prefetch" href="/blog/assets/js/101.621565b8.js"><link rel="prefetch" href="/blog/assets/js/102.abd5a320.js"><link rel="prefetch" href="/blog/assets/js/103.6f5a3cf9.js"><link rel="prefetch" href="/blog/assets/js/104.03096147.js"><link rel="prefetch" href="/blog/assets/js/105.93fa8568.js"><link rel="prefetch" href="/blog/assets/js/106.f8e8e430.js"><link rel="prefetch" href="/blog/assets/js/107.8c51e30a.js"><link rel="prefetch" href="/blog/assets/js/108.e0357003.js"><link rel="prefetch" href="/blog/assets/js/109.18e07e11.js"><link rel="prefetch" href="/blog/assets/js/11.4b95c25c.js"><link rel="prefetch" href="/blog/assets/js/110.10aafd35.js"><link rel="prefetch" href="/blog/assets/js/111.f48db1a5.js"><link rel="prefetch" href="/blog/assets/js/112.5798b1a1.js"><link rel="prefetch" href="/blog/assets/js/113.7f3d9276.js"><link rel="prefetch" href="/blog/assets/js/114.cb641292.js"><link rel="prefetch" href="/blog/assets/js/115.2fbba0a4.js"><link rel="prefetch" href="/blog/assets/js/116.878e5be8.js"><link rel="prefetch" href="/blog/assets/js/117.21198ead.js"><link rel="prefetch" href="/blog/assets/js/118.75c62650.js"><link rel="prefetch" href="/blog/assets/js/119.8c07a87e.js"><link rel="prefetch" href="/blog/assets/js/12.ec1ff2d4.js"><link rel="prefetch" href="/blog/assets/js/120.aa67e285.js"><link rel="prefetch" href="/blog/assets/js/121.0ef2b6d1.js"><link rel="prefetch" href="/blog/assets/js/122.4200cefa.js"><link rel="prefetch" href="/blog/assets/js/123.a34af88b.js"><link rel="prefetch" href="/blog/assets/js/124.ee97a73c.js"><link rel="prefetch" href="/blog/assets/js/125.a38b6e69.js"><link rel="prefetch" href="/blog/assets/js/126.4282cb22.js"><link rel="prefetch" href="/blog/assets/js/127.f706f89d.js"><link rel="prefetch" href="/blog/assets/js/128.da3229ad.js"><link rel="prefetch" href="/blog/assets/js/129.199a2d3b.js"><link rel="prefetch" href="/blog/assets/js/13.5b0ead3f.js"><link rel="prefetch" href="/blog/assets/js/130.52f09e02.js"><link rel="prefetch" href="/blog/assets/js/131.25de3249.js"><link rel="prefetch" href="/blog/assets/js/132.e5a040c5.js"><link rel="prefetch" href="/blog/assets/js/133.0fd55eb5.js"><link rel="prefetch" href="/blog/assets/js/134.31264bda.js"><link rel="prefetch" href="/blog/assets/js/135.906b5668.js"><link rel="prefetch" href="/blog/assets/js/136.cf729443.js"><link rel="prefetch" href="/blog/assets/js/137.68e148ac.js"><link rel="prefetch" href="/blog/assets/js/138.c62c6ad5.js"><link rel="prefetch" href="/blog/assets/js/139.9151be85.js"><link rel="prefetch" href="/blog/assets/js/14.756d2420.js"><link rel="prefetch" href="/blog/assets/js/140.9fd2563f.js"><link rel="prefetch" href="/blog/assets/js/141.c97181e9.js"><link rel="prefetch" href="/blog/assets/js/142.0c6f1a38.js"><link rel="prefetch" href="/blog/assets/js/143.93512b60.js"><link rel="prefetch" href="/blog/assets/js/144.dd167bbd.js"><link rel="prefetch" href="/blog/assets/js/145.95d06ac3.js"><link rel="prefetch" href="/blog/assets/js/146.4ccbea8b.js"><link rel="prefetch" href="/blog/assets/js/147.2fa19a48.js"><link rel="prefetch" href="/blog/assets/js/148.9bd27110.js"><link rel="prefetch" href="/blog/assets/js/149.7dd674ee.js"><link rel="prefetch" href="/blog/assets/js/15.f08be4b3.js"><link rel="prefetch" href="/blog/assets/js/150.c87fed9f.js"><link rel="prefetch" href="/blog/assets/js/151.923ca93c.js"><link rel="prefetch" href="/blog/assets/js/152.1bc490cf.js"><link rel="prefetch" href="/blog/assets/js/153.ec01a774.js"><link rel="prefetch" href="/blog/assets/js/154.8b22d976.js"><link rel="prefetch" href="/blog/assets/js/155.dd9307b0.js"><link rel="prefetch" href="/blog/assets/js/156.aa050756.js"><link rel="prefetch" href="/blog/assets/js/157.815a4bbc.js"><link rel="prefetch" href="/blog/assets/js/158.c0787141.js"><link rel="prefetch" href="/blog/assets/js/159.c9dd554e.js"><link rel="prefetch" href="/blog/assets/js/16.959420de.js"><link rel="prefetch" href="/blog/assets/js/160.137cde2c.js"><link rel="prefetch" href="/blog/assets/js/161.d1277dee.js"><link rel="prefetch" href="/blog/assets/js/162.c2d0d9fd.js"><link rel="prefetch" href="/blog/assets/js/163.39820f75.js"><link rel="prefetch" href="/blog/assets/js/164.6151bcb8.js"><link rel="prefetch" href="/blog/assets/js/165.41a03e0d.js"><link rel="prefetch" href="/blog/assets/js/167.3f37f92b.js"><link rel="prefetch" href="/blog/assets/js/168.50ec0147.js"><link rel="prefetch" href="/blog/assets/js/169.a448236a.js"><link rel="prefetch" href="/blog/assets/js/17.8d52c635.js"><link rel="prefetch" href="/blog/assets/js/170.f2454eb6.js"><link rel="prefetch" href="/blog/assets/js/171.8ea3fafa.js"><link rel="prefetch" href="/blog/assets/js/172.97da2551.js"><link rel="prefetch" href="/blog/assets/js/173.7d568de9.js"><link rel="prefetch" href="/blog/assets/js/174.109e1eb6.js"><link rel="prefetch" href="/blog/assets/js/175.2c7106f6.js"><link rel="prefetch" href="/blog/assets/js/176.6249a9ea.js"><link rel="prefetch" href="/blog/assets/js/177.7c1ed98c.js"><link rel="prefetch" href="/blog/assets/js/178.03a18105.js"><link rel="prefetch" href="/blog/assets/js/179.a967c6e3.js"><link rel="prefetch" href="/blog/assets/js/18.b38418e9.js"><link rel="prefetch" href="/blog/assets/js/180.264d5e17.js"><link rel="prefetch" href="/blog/assets/js/181.863cfa96.js"><link rel="prefetch" href="/blog/assets/js/182.55dad1e2.js"><link rel="prefetch" href="/blog/assets/js/183.ae6b4d03.js"><link rel="prefetch" href="/blog/assets/js/19.d6339a52.js"><link rel="prefetch" href="/blog/assets/js/2.74a55342.js"><link rel="prefetch" href="/blog/assets/js/20.be2a3956.js"><link rel="prefetch" href="/blog/assets/js/21.aac0786d.js"><link rel="prefetch" href="/blog/assets/js/22.07d0437f.js"><link rel="prefetch" href="/blog/assets/js/23.7a2e8419.js"><link rel="prefetch" href="/blog/assets/js/24.f9d15a64.js"><link rel="prefetch" href="/blog/assets/js/25.7d558f9d.js"><link rel="prefetch" href="/blog/assets/js/26.0cbd3ca9.js"><link rel="prefetch" href="/blog/assets/js/27.507bc5e7.js"><link rel="prefetch" href="/blog/assets/js/28.ab3ca00b.js"><link rel="prefetch" href="/blog/assets/js/29.e2cfd06a.js"><link rel="prefetch" href="/blog/assets/js/30.8ca807cc.js"><link rel="prefetch" href="/blog/assets/js/31.1adcb0a5.js"><link rel="prefetch" href="/blog/assets/js/32.30794034.js"><link rel="prefetch" href="/blog/assets/js/33.ad7ee5cc.js"><link rel="prefetch" href="/blog/assets/js/34.fc351def.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.32f090a2.js"><link rel="prefetch" href="/blog/assets/js/37.b4b36c0e.js"><link rel="prefetch" href="/blog/assets/js/38.339db685.js"><link rel="prefetch" href="/blog/assets/js/39.d012b075.js"><link rel="prefetch" href="/blog/assets/js/4.85a42d17.js"><link rel="prefetch" href="/blog/assets/js/40.b67f9f4a.js"><link rel="prefetch" href="/blog/assets/js/41.ddec1210.js"><link rel="prefetch" href="/blog/assets/js/42.58d4c38b.js"><link rel="prefetch" href="/blog/assets/js/43.349e611a.js"><link rel="prefetch" href="/blog/assets/js/44.f327f050.js"><link rel="prefetch" href="/blog/assets/js/45.5b78689d.js"><link rel="prefetch" href="/blog/assets/js/46.c1d70453.js"><link rel="prefetch" href="/blog/assets/js/47.dfd780d0.js"><link rel="prefetch" href="/blog/assets/js/48.5743718f.js"><link rel="prefetch" href="/blog/assets/js/49.9ca593b1.js"><link rel="prefetch" href="/blog/assets/js/5.bc12a0a5.js"><link rel="prefetch" href="/blog/assets/js/50.39e017f0.js"><link rel="prefetch" href="/blog/assets/js/51.3c7e7718.js"><link rel="prefetch" href="/blog/assets/js/52.c183fd4d.js"><link rel="prefetch" href="/blog/assets/js/53.ea79a958.js"><link rel="prefetch" href="/blog/assets/js/54.e65f5d09.js"><link rel="prefetch" href="/blog/assets/js/55.8b1c97ea.js"><link rel="prefetch" href="/blog/assets/js/56.083e4ae1.js"><link rel="prefetch" href="/blog/assets/js/57.99344d20.js"><link rel="prefetch" href="/blog/assets/js/58.e4ce164d.js"><link rel="prefetch" href="/blog/assets/js/59.7b89f0b8.js"><link rel="prefetch" href="/blog/assets/js/6.aac072d7.js"><link rel="prefetch" href="/blog/assets/js/60.b4bd558a.js"><link rel="prefetch" href="/blog/assets/js/61.953c1ff1.js"><link rel="prefetch" href="/blog/assets/js/62.675b2c2d.js"><link rel="prefetch" href="/blog/assets/js/63.c7756200.js"><link rel="prefetch" href="/blog/assets/js/64.105f0255.js"><link rel="prefetch" href="/blog/assets/js/65.72dbc8b3.js"><link rel="prefetch" href="/blog/assets/js/66.33bf686a.js"><link rel="prefetch" href="/blog/assets/js/67.added4fb.js"><link rel="prefetch" href="/blog/assets/js/68.2d75999d.js"><link rel="prefetch" href="/blog/assets/js/69.789b2068.js"><link rel="prefetch" href="/blog/assets/js/7.598fcf35.js"><link rel="prefetch" href="/blog/assets/js/70.dc2938ec.js"><link rel="prefetch" href="/blog/assets/js/71.8978e5e2.js"><link rel="prefetch" href="/blog/assets/js/72.49706859.js"><link rel="prefetch" href="/blog/assets/js/73.c7f51aff.js"><link rel="prefetch" href="/blog/assets/js/74.e8b35b3e.js"><link rel="prefetch" href="/blog/assets/js/75.46e475b8.js"><link rel="prefetch" href="/blog/assets/js/76.2998707b.js"><link rel="prefetch" href="/blog/assets/js/77.a03bb11c.js"><link rel="prefetch" href="/blog/assets/js/78.9e21284f.js"><link rel="prefetch" href="/blog/assets/js/79.4d7c83db.js"><link rel="prefetch" href="/blog/assets/js/8.8f057574.js"><link rel="prefetch" href="/blog/assets/js/80.cbee4892.js"><link rel="prefetch" href="/blog/assets/js/81.dd90612f.js"><link rel="prefetch" href="/blog/assets/js/82.72a043ee.js"><link rel="prefetch" href="/blog/assets/js/83.218b78b0.js"><link rel="prefetch" href="/blog/assets/js/84.33752695.js"><link rel="prefetch" href="/blog/assets/js/85.c5bc3a64.js"><link rel="prefetch" href="/blog/assets/js/86.a8a4988e.js"><link rel="prefetch" href="/blog/assets/js/87.8bba3a3a.js"><link rel="prefetch" href="/blog/assets/js/88.4b136e7f.js"><link rel="prefetch" href="/blog/assets/js/89.77f04e86.js"><link rel="prefetch" href="/blog/assets/js/9.43c8ee0b.js"><link rel="prefetch" href="/blog/assets/js/90.2e4e24f9.js"><link rel="prefetch" href="/blog/assets/js/91.a474434d.js"><link rel="prefetch" href="/blog/assets/js/92.781278fb.js"><link rel="prefetch" href="/blog/assets/js/93.0651f3ab.js"><link rel="prefetch" href="/blog/assets/js/94.e8b9861b.js"><link rel="prefetch" href="/blog/assets/js/95.6987fefc.js"><link rel="prefetch" href="/blog/assets/js/96.a43fcfd0.js"><link rel="prefetch" href="/blog/assets/js/97.bca7af89.js"><link rel="prefetch" href="/blog/assets/js/98.cb17a28e.js"><link rel="prefetch" href="/blog/assets/js/99.2f912aba.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b3aba94c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/数据库/Mysql/1视图-触发器-存储过程" class="sidebar-heading clickable open"><span>Mysql</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/数据库/Mysql/1视图-触发器-存储过程.html" class="sidebar-link">视图，存储过程，触发器</a></li><li><a href="/blog/数据库/Mysql/2物化视图-事务.html" class="sidebar-link">物化视图-事务</a></li><li><a href="/blog/数据库/Mysql/3事务日志与锁初体验.html" class="sidebar-link">事务与锁</a></li><li><a href="/blog/数据库/Mysql/4事务隔离与锁的关系.html" class="sidebar-link">事务隔离与锁的关系</a></li><li><a href="/blog/数据库/Mysql/5锁机制与数据库结构.html" class="sidebar-link">锁机制与数据库结构</a></li><li><a href="/blog/数据库/Mysql/6数据库文件.html" class="sidebar-link">数据库结构</a></li><li><a href="/blog/数据库/Mysql/7结构与存储引擎.html" class="sidebar-link">数据库结构详解</a></li><li><a href="/blog/数据库/Mysql/8发现问题.html" class="sidebar-link">问题发现</a></li><li><a href="/blog/数据库/Mysql/9数据库的基础设计.html" class="sidebar-link">数据库基础设计与表设计</a></li><li><a href="/blog/数据库/Mysql/10数据库字段选择与sql执行.html" class="sidebar-link">数据表字段选择与SQL执行流程</a></li><li><a href="/blog/数据库/Mysql/11sql分析.html" class="sidebar-link">sql分析</a></li><li><a href="/blog/数据库/Mysql/12explain实例与IO操作.html" class="sidebar-link">explain实例与IO操作</a></li><li><a href="/blog/数据库/Mysql/13SQL执行IO操作及索引基础.html" class="sidebar-link">SQL执行IO操作及索引基础</a></li><li><a href="/blog/数据库/Mysql/14索引基础.html" class="sidebar-link">索引基础</a></li><li><a href="/blog/数据库/Mysql/15SQL优化实例.html" class="sidebar-link">SQL优化案例实践</a></li><li><a href="/blog/数据库/Mysql/16join初步.html" class="sidebar-link">join 初步</a></li><li><a href="/blog/数据库/Mysql/17join优化思路.html" class="active sidebar-link">join优化以及条件解析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/数据库/Mysql/20索引总结iCP与where提取.html" class="sidebar-link">索引总结iCP与where提取</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="join优化以及条件解析"><a href="#join优化以及条件解析" class="header-anchor">#</a> join优化以及条件解析</h1> <h3 id="_0-课程内容"><a href="#_0-课程内容" class="header-anchor">#</a> 0. 课程内容</h3> <pre>1. 课程回顾
   1.1 第五题
   1.2 5.5与5.7 版本之间子查询的区别
   1.3 join算法
   1.4 连接驱动表选择
2. join的实现原理及优化思路
3. 性客户的数量和平均月薪&amp;不同城市的客户数量和平均月薪
4. 列出没有手机号码，或者没有照片，或者没有年奖金的客户姓名
5. 不同年龄段(0到100岁之间，每10岁为一个年龄段)的客户平均年收入&amp;列出每个城市的年收入最高和最低的男性和女性的姓名和年收入
</pre> <h3 id="_1-join的实现原理及优化思路"><a href="#_1-join的实现原理及优化思路" class="header-anchor">#</a> 1. join的实现原理及优化思路</h3> <p>MySQL中对于join的实现主要是通过Nest额的 Loop join算法处理的，其他数据库可能是使用hash join以及sort merge join。NLJ实际上就是通过驱动表的结构及作为循环基础数据，然后讲该结果集中的数据作为过滤条件一条条第到下一个表中查询数据，最后合并结构。如果还有第三个表参与join，则把前面两个表的join结果集作为循环基础数据，再一次通过循环查询条件到第三个表中查询数据，以此往下推</p> <p>优化的思路：尽可能减少 Join 语句中的 Nested Loop 的循环总次数；<br>
如何减少 Nested Loop 的循环总次数？最有效的办法只有一个，那就是让驱动表的结果集尽可能的小，这也正是在本章第二节中的优化基本原则之一“永远用小结果集驱动大的结果集”。</p> <ol><li>优先优化 Nested Loop 的内层循环；</li> <li>保证 Join 语句中被驱动表上 Join 条件字段已经被索引；</li> <li>当无法保证被驱动表的 Join 条件字段被索引且内存资源充足的前提下，不要太吝惜 JoinBuffer 的设置；</li></ol> <p>两个 for 连接关系</p> <ol><li>外 * 内 = 循环次数</li> <li>尽量让关联字段在索引上 主键(hash)</li> <li>join buffer</li></ol> <p>for (){ 外<br>
for(){ 内<br>
}<br>
}</p> <h3 id="_2-性客户的数量和平均月薪-不同城市的客户数量和平均月薪"><a href="#_2-性客户的数量和平均月薪-不同城市的客户数量和平均月薪" class="header-anchor">#</a> 2. 性客户的数量和平均月薪&amp;不同城市的客户数量和平均月薪</h3> <p>通过explain分析一下</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>monthsalary<span class="token punctuation">)</span> <span class="token keyword">from</span>	customers c<span class="token punctuation">,</span>salary s <span class="token keyword">where</span> c<span class="token punctuation">.</span>gender <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">and</span> c<span class="token punctuation">.</span>id<span class="token operator">=</span>s<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+--------+---------------+---------+---------+--------------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref          <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+--------+---------------+---------+---------+--------------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> c     <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>         <span class="token operator">|</span> <span class="token number">992340</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> s     <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">60</span>      <span class="token operator">|</span> mysql12<span class="token punctuation">.</span>c<span class="token punctuation">.</span>id <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+--------+---------------+---------+---------+--------------+--------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>monthsalary<span class="token punctuation">)</span> <span class="token keyword">from</span>  customers c<span class="token punctuation">,</span>salary s <span class="token keyword">where</span> c<span class="token punctuation">.</span>id<span class="token operator">=</span>s<span class="token punctuation">.</span>id <span class="token keyword">group</span> <span class="token keyword">by</span> c<span class="token punctuation">.</span>city \G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
           id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
        <span class="token keyword">table</span>: s
   partitions: <span class="token boolean">NULL</span>
         <span class="token keyword">type</span>: <span class="token keyword">ALL</span>
possible_keys: <span class="token keyword">PRIMARY</span>
          <span class="token keyword">key</span>: <span class="token boolean">NULL</span>
      key_len: <span class="token boolean">NULL</span>
          ref: <span class="token boolean">NULL</span>
         <span class="token keyword">rows</span>: <span class="token number">980276</span>
     filtered: <span class="token number">100.00</span>
        Extra: <span class="token keyword">Using</span> <span class="token keyword">temporary</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
           id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
        <span class="token keyword">table</span>: c
   partitions: <span class="token boolean">NULL</span>
         <span class="token keyword">type</span>: eq_ref
possible_keys: <span class="token keyword">PRIMARY</span>
          <span class="token keyword">key</span>: <span class="token keyword">PRIMARY</span>
      key_len: <span class="token number">60</span>
          ref: mysql12<span class="token punctuation">.</span>s<span class="token punctuation">.</span>id
         <span class="token keyword">rows</span>: <span class="token number">1</span>
     filtered: <span class="token number">100.00</span>
        Extra: <span class="token boolean">NULL</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>通过如上的分析，第一个SQL使用的是customers作为了驱动表，而第二个则是使用的是salary作为驱动表。之所以选择主要是因为MySQL的优化器会先获取两个表的结构信息，根据表的大小优先选择小表然后再选择大表，但是在其中有条件的情况下会选择与根据条件刷选之后的数据表，相对来说数据会少一些</p> <p>当然优化就比较简单分别对于salary与customers表建立对应的索引就可以(gender,city)和(monthsalary)</p> <h3 id="_3-列出没有手机号码-或者没有照片-或者没有年奖金的客户姓名"><a href="#_3-列出没有手机号码-或者没有照片-或者没有年奖金的客户姓名" class="header-anchor">#</a> 3. 列出没有手机号码，或者没有照片，或者没有年奖金的客户姓名</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers<span class="token punctuation">,</span>salary <span class="token keyword">where</span> customers<span class="token punctuation">.</span>id <span class="token operator">=</span> salary<span class="token punctuation">.</span>id <span class="token operator">and</span> <span class="token punctuation">(</span>photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+--------+---------------+---------+---------+-------------------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>     <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+--------+---------------+---------+---------+-------------------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> salary    <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span> <span class="token number">473912</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">60</span>      <span class="token operator">|</span> mysql12<span class="token punctuation">.</span>salary<span class="token punctuation">.</span>id <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+--------+---------------+---------+---------+-------------------+--------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers<span class="token punctuation">,</span>salary <span class="token keyword">where</span> <span class="token punctuation">(</span>photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">and</span> customers<span class="token punctuation">.</span>id <span class="token operator">=</span> salary<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+--------+---------------+---------+---------+-------------------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>     <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref               <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+--------+---------------+---------+---------+-------------------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> salary    <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>              <span class="token operator">|</span> <span class="token number">473912</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">60</span>      <span class="token operator">|</span> mysql12<span class="token punctuation">.</span>salary<span class="token punctuation">.</span>id <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+--------+---------------+---------+---------+-------------------+--------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

注意不要这么写：
<span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers<span class="token punctuation">,</span>salary <span class="token keyword">where</span> customers<span class="token punctuation">.</span>id <span class="token operator">=</span> salary<span class="token punctuation">.</span>id <span class="token operator">and</span> photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------+---------------+--------+----------+----------------------------------------------------</span>
<span class="token operator">+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>     <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------+---------------+--------+----------+----------------------------------------------------</span>
<span class="token operator">+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> salary    <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token number">473912</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>
<span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token number">490153</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">join</span> buffer <span class="token punctuation">(</span>Block Nested <span class="token keyword">Loop</span><span class="token punctuation">)</span>
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------+---------------+--------+----------+----------------------------------------------------</span>
<span class="token operator">+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>如上是通过explain分析之后的，在实际执行的过程</p> <p><img src="assets/markdown-img-paste-20190618171602303.png" alt=""></p> <p>实际上第一条的执行SQL的速度会比第二条要慢，差距并不是太明显；这主要是因为与MySQL在进行执行的时候已经根据对应的条件事先过滤了一遍数据，然后再去进行关联 ；而第三条通过explain分析，发现两个表都进行了全表的扫描，并且是通过block nested loop的方式进行join的连接；而第三种很显然是效率最低的，主要是MySQL不确定相互之间的关联where的条件</p> <p>现在改为之前的union all在前面提过的方法对于 一个表的优化方式：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> name <span class="token keyword">from</span> customers<span class="token punctuation">,</span>salary <span class="token keyword">where</span> customers<span class="token punctuation">.</span>photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">and</span> customers<span class="token punctuation">.</span>id <span class="token operator">=</span> salary<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers<span class="token punctuation">,</span>salary <span class="token keyword">where</span> customers<span class="token punctuation">.</span>mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">and</span> customers<span class="token punctuation">.</span>id <span class="token operator">=</span> salary<span class="token punctuation">.</span>id
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name from1 customers<span class="token punctuation">,</span>salary <span class="token keyword">where</span> salary<span class="token punctuation">.</span>yearbonus <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">and</span> customers<span class="token punctuation">.</span>id <span class="token operator">=</span> salary<span class="token punctuation">.</span>id   <span class="token comment">-- 1.488s</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> salary <span class="token keyword">where</span> salary<span class="token punctuation">.</span>yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">-- 0.944s</span>

我们会发现之前的方法不合适了主要是进行了三次对于两个表进行扫描，但是如果只是根据题目的意思的话实际上<span class="token keyword">SQL</span>可以这么写

<span class="token keyword">select</span> name <span class="token keyword">from</span> customers <span class="token keyword">where</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">and</span>  photo <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> salary <span class="token keyword">where</span> salary<span class="token punctuation">.</span>yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">-- 0.765s</span>

那么这个时候我们就可以单独针对于如上的两条<span class="token keyword">SQL</span>进行优化实际上最好的优化方式是（建立的索引）

<span class="token keyword">alter</span> <span class="token keyword">table</span> customers <span class="token keyword">add</span> <span class="token keyword">index</span> idx_mobile_photo_name<span class="token punctuation">(</span>mobile<span class="token punctuation">,</span>photo<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> salary <span class="token keyword">add</span> <span class="token keyword">index</span> idx_yearbonus<span class="token punctuation">(</span>yearbonus<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于idx_mobile_photo_name的解释，在where中我们对于mobile，photo，name定义了一个关联的索引对于MySQL来说；会查找where上的(所有)字段是否包含在了某一个索引中如果说存在就会生效</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers <span class="token keyword">where</span> mobile <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">and</span>  photo <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------+-----------------------+-----------------------+---------+-------------+--------+----------+--------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>     <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys         <span class="token operator">|</span> <span class="token keyword">key</span>                   <span class="token operator">|</span> key_len <span class="token operator">|</span> ref         <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------+-----------------------+-----------------------+---------+-------------+--------+----------+--------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_mobile_photo_name <span class="token operator">|</span> idx_mobile_photo_name <span class="token operator">|</span> <span class="token number">95</span>      <span class="token operator">|</span> const<span class="token punctuation">,</span>const <span class="token operator">|</span> <span class="token number">245076</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------+-----------------------+-----------------------+---------+-------------+--------+----------+--------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers <span class="token keyword">where</span> mobile <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">and</span>  photo <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">or</span> gender <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------------+------+---------------------------------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>     <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys                         <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------------+------+---------------------------------------+------+---------+------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> idx_gender_city<span class="token punctuation">,</span>idx_mobile_photo_name <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">490153</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------------+------+---------------------------------------+------+---------+------+--------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>where上的所有字段列只要有一个不存在于MySQL的其中一个联合索引就不会使用到索引</p> <h3 id="_4-不同年龄段-0到100岁之间-每10岁为一个年龄段-的客户平均年收入-列出每个城市的年收入最高和最低的男性和女性的姓名和年收入"><a href="#_4-不同年龄段-0到100岁之间-每10岁为一个年龄段-的客户平均年收入-列出每个城市的年收入最高和最低的男性和女性的姓名和年收入" class="header-anchor">#</a> 4. 不同年龄段(0到100岁之间，每10岁为一个年龄段)的客户平均年收入&amp;列出每个城市的年收入最高和最低的男性和女性的姓名和年收入</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>


</code></pre></div><p>索引在联合查询的时候驱动以及索引的建立</p> <p>驱动表选择,建立索引之后优化效率最高的</p> <p>背景:数据量相同的情况下<br>
知识:正常的没有join连接小表做驱动</p> <p>数据量(驱动表刷选之后的数据量) &gt; 大表的查询率低于小表的查询, 优化考虑大表 查询效率 &gt; 优化考虑获取是否进行函数操作(获取之后还需进行函数处理就考虑优化使用函数字段的表)</p> <p>本质是全表的查询就要考虑优化大表</p> <p>同等的大小:优化考虑获取列的复杂度(获取之后还需进行函数处理就考虑优化使用函数字段的表)</p> <p>customers</p> <p>优化的核心点:选择最需要优化</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>a<span class="token punctuation">.</span>city<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>monthsalary <span class="token operator">*</span> <span class="token number">12</span> <span class="token operator">+</span> yearbonus<span class="token punctuation">)</span> <span class="token keyword">as</span> income <span class="token keyword">from</span> customers a <span class="token punctuation">,</span>salary b <span class="token keyword">where</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id <span class="token keyword">group</span> <span class="token keyword">by</span> gender<span class="token punctuation">,</span>city
</code></pre></div><ol><li>表大小</li> <li>获取的列 -&gt; 是否有做运算 -&gt; 运算复杂</li></ol> <h3 id="_3-问题"><a href="#_3-问题" class="header-anchor">#</a> 3. 问题</h3> <pre>1. 一般on后面都是用主键关联的吧，用主键做条件有什么问题吗？
   主要是非驱动表会使用这个主键作为索引条件查询,而作为主键通常来说并不会与其他字段再建立以主键为第一个的联合索引,因此对于非驱动表的where上的查询条件就很难使用到索引了.

   先查询驱动表数据 驱动关联的字段 去找非驱动表中的数据

2. 唯一索引页可以起主键索引的效果吗? yes - idx_col_id();

3. 用主键索引应该好过用下面yearbonus的索引好吧，这里怎么判断用哪个索引好的?
   a. mysql的优化器会进行索引的推导选择与合适的索引,通常来说是会选择合适的索引的,但是有些时候我们还是需要自己去根据自己定义的索引来强制mysql索引索引,因为mysql他也会存在失误判断的情况.
   b. 判断的方式主要是看索引上的使用率,简单来说定义的索引包含的字段在SQL中能够使用到

4. 是建议用主键做条件，还是不建议?
   这个问题没有绝对答案,但是通常来说推荐主键作为条件在单表的时候在join的时候不一定了如上1有解释;因此单表推荐使用主键作为条件,join看实际操作吧并不是特别推荐有限制

5. 使用order by 是不是总会出现隐式临时表Using temporary？order by有没有可优化的空间。(group by 也是)
    mysql是先根据where 从磁盘中获取数据(using where 和 using index) ;然后会把他们变成虚拟表再进行排序所以会有(Using temporary)
</pre> <ul><li></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/数据库/Mysql/16join初步.html" class="prev">
        join 初步
      </a></span> <span class="next"><a href="/blog/数据库/Mysql/20索引总结iCP与where提取.html">
        索引总结iCP与where提取
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.402a9c30.js" defer></script><script src="/blog/assets/js/3.64b046d0.js" defer></script><script src="/blog/assets/js/166.984417c0.js" defer></script>
  </body>
</html>
