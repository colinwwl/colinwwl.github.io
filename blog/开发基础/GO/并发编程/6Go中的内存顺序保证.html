<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Go中的内存顺序保证 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b3aba94c.css" as="style"><link rel="preload" href="/blog/assets/js/app.402a9c30.js" as="script"><link rel="preload" href="/blog/assets/js/3.64b046d0.js" as="script"><link rel="preload" href="/blog/assets/js/118.75c62650.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.96001213.js"><link rel="prefetch" href="/blog/assets/js/100.056ffb3b.js"><link rel="prefetch" href="/blog/assets/js/101.621565b8.js"><link rel="prefetch" href="/blog/assets/js/102.abd5a320.js"><link rel="prefetch" href="/blog/assets/js/103.6f5a3cf9.js"><link rel="prefetch" href="/blog/assets/js/104.03096147.js"><link rel="prefetch" href="/blog/assets/js/105.93fa8568.js"><link rel="prefetch" href="/blog/assets/js/106.f8e8e430.js"><link rel="prefetch" href="/blog/assets/js/107.8c51e30a.js"><link rel="prefetch" href="/blog/assets/js/108.e0357003.js"><link rel="prefetch" href="/blog/assets/js/109.18e07e11.js"><link rel="prefetch" href="/blog/assets/js/11.4b95c25c.js"><link rel="prefetch" href="/blog/assets/js/110.10aafd35.js"><link rel="prefetch" href="/blog/assets/js/111.f48db1a5.js"><link rel="prefetch" href="/blog/assets/js/112.5798b1a1.js"><link rel="prefetch" href="/blog/assets/js/113.7f3d9276.js"><link rel="prefetch" href="/blog/assets/js/114.cb641292.js"><link rel="prefetch" href="/blog/assets/js/115.2fbba0a4.js"><link rel="prefetch" href="/blog/assets/js/116.878e5be8.js"><link rel="prefetch" href="/blog/assets/js/117.21198ead.js"><link rel="prefetch" href="/blog/assets/js/119.8c07a87e.js"><link rel="prefetch" href="/blog/assets/js/12.ec1ff2d4.js"><link rel="prefetch" href="/blog/assets/js/120.aa67e285.js"><link rel="prefetch" href="/blog/assets/js/121.0ef2b6d1.js"><link rel="prefetch" href="/blog/assets/js/122.4200cefa.js"><link rel="prefetch" href="/blog/assets/js/123.a34af88b.js"><link rel="prefetch" href="/blog/assets/js/124.ee97a73c.js"><link rel="prefetch" href="/blog/assets/js/125.a38b6e69.js"><link rel="prefetch" href="/blog/assets/js/126.4282cb22.js"><link rel="prefetch" href="/blog/assets/js/127.f706f89d.js"><link rel="prefetch" href="/blog/assets/js/128.da3229ad.js"><link rel="prefetch" href="/blog/assets/js/129.199a2d3b.js"><link rel="prefetch" href="/blog/assets/js/13.5b0ead3f.js"><link rel="prefetch" href="/blog/assets/js/130.52f09e02.js"><link rel="prefetch" href="/blog/assets/js/131.25de3249.js"><link rel="prefetch" href="/blog/assets/js/132.e5a040c5.js"><link rel="prefetch" href="/blog/assets/js/133.0fd55eb5.js"><link rel="prefetch" href="/blog/assets/js/134.31264bda.js"><link rel="prefetch" href="/blog/assets/js/135.906b5668.js"><link rel="prefetch" href="/blog/assets/js/136.cf729443.js"><link rel="prefetch" href="/blog/assets/js/137.68e148ac.js"><link rel="prefetch" href="/blog/assets/js/138.c62c6ad5.js"><link rel="prefetch" href="/blog/assets/js/139.9151be85.js"><link rel="prefetch" href="/blog/assets/js/14.756d2420.js"><link rel="prefetch" href="/blog/assets/js/140.9fd2563f.js"><link rel="prefetch" href="/blog/assets/js/141.c97181e9.js"><link rel="prefetch" href="/blog/assets/js/142.0c6f1a38.js"><link rel="prefetch" href="/blog/assets/js/143.93512b60.js"><link rel="prefetch" href="/blog/assets/js/144.dd167bbd.js"><link rel="prefetch" href="/blog/assets/js/145.95d06ac3.js"><link rel="prefetch" href="/blog/assets/js/146.4ccbea8b.js"><link rel="prefetch" href="/blog/assets/js/147.2fa19a48.js"><link rel="prefetch" href="/blog/assets/js/148.9bd27110.js"><link rel="prefetch" href="/blog/assets/js/149.7dd674ee.js"><link rel="prefetch" href="/blog/assets/js/15.f08be4b3.js"><link rel="prefetch" href="/blog/assets/js/150.c87fed9f.js"><link rel="prefetch" href="/blog/assets/js/151.923ca93c.js"><link rel="prefetch" href="/blog/assets/js/152.1bc490cf.js"><link rel="prefetch" href="/blog/assets/js/153.ec01a774.js"><link rel="prefetch" href="/blog/assets/js/154.8b22d976.js"><link rel="prefetch" href="/blog/assets/js/155.dd9307b0.js"><link rel="prefetch" href="/blog/assets/js/156.aa050756.js"><link rel="prefetch" href="/blog/assets/js/157.815a4bbc.js"><link rel="prefetch" href="/blog/assets/js/158.c0787141.js"><link rel="prefetch" href="/blog/assets/js/159.c9dd554e.js"><link rel="prefetch" href="/blog/assets/js/16.959420de.js"><link rel="prefetch" href="/blog/assets/js/160.137cde2c.js"><link rel="prefetch" href="/blog/assets/js/161.d1277dee.js"><link rel="prefetch" href="/blog/assets/js/162.c2d0d9fd.js"><link rel="prefetch" href="/blog/assets/js/163.39820f75.js"><link rel="prefetch" href="/blog/assets/js/164.6151bcb8.js"><link rel="prefetch" href="/blog/assets/js/165.41a03e0d.js"><link rel="prefetch" href="/blog/assets/js/166.984417c0.js"><link rel="prefetch" href="/blog/assets/js/167.3f37f92b.js"><link rel="prefetch" href="/blog/assets/js/168.50ec0147.js"><link rel="prefetch" href="/blog/assets/js/169.a448236a.js"><link rel="prefetch" href="/blog/assets/js/17.8d52c635.js"><link rel="prefetch" href="/blog/assets/js/170.f2454eb6.js"><link rel="prefetch" href="/blog/assets/js/171.8ea3fafa.js"><link rel="prefetch" href="/blog/assets/js/172.97da2551.js"><link rel="prefetch" href="/blog/assets/js/173.7d568de9.js"><link rel="prefetch" href="/blog/assets/js/174.109e1eb6.js"><link rel="prefetch" href="/blog/assets/js/175.2c7106f6.js"><link rel="prefetch" href="/blog/assets/js/176.6249a9ea.js"><link rel="prefetch" href="/blog/assets/js/177.7c1ed98c.js"><link rel="prefetch" href="/blog/assets/js/178.03a18105.js"><link rel="prefetch" href="/blog/assets/js/179.a967c6e3.js"><link rel="prefetch" href="/blog/assets/js/18.b38418e9.js"><link rel="prefetch" href="/blog/assets/js/180.264d5e17.js"><link rel="prefetch" href="/blog/assets/js/181.863cfa96.js"><link rel="prefetch" href="/blog/assets/js/182.55dad1e2.js"><link rel="prefetch" href="/blog/assets/js/183.ae6b4d03.js"><link rel="prefetch" href="/blog/assets/js/19.d6339a52.js"><link rel="prefetch" href="/blog/assets/js/2.74a55342.js"><link rel="prefetch" href="/blog/assets/js/20.be2a3956.js"><link rel="prefetch" href="/blog/assets/js/21.aac0786d.js"><link rel="prefetch" href="/blog/assets/js/22.07d0437f.js"><link rel="prefetch" href="/blog/assets/js/23.7a2e8419.js"><link rel="prefetch" href="/blog/assets/js/24.f9d15a64.js"><link rel="prefetch" href="/blog/assets/js/25.7d558f9d.js"><link rel="prefetch" href="/blog/assets/js/26.0cbd3ca9.js"><link rel="prefetch" href="/blog/assets/js/27.507bc5e7.js"><link rel="prefetch" href="/blog/assets/js/28.ab3ca00b.js"><link rel="prefetch" href="/blog/assets/js/29.e2cfd06a.js"><link rel="prefetch" href="/blog/assets/js/30.8ca807cc.js"><link rel="prefetch" href="/blog/assets/js/31.1adcb0a5.js"><link rel="prefetch" href="/blog/assets/js/32.30794034.js"><link rel="prefetch" href="/blog/assets/js/33.ad7ee5cc.js"><link rel="prefetch" href="/blog/assets/js/34.fc351def.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.32f090a2.js"><link rel="prefetch" href="/blog/assets/js/37.b4b36c0e.js"><link rel="prefetch" href="/blog/assets/js/38.339db685.js"><link rel="prefetch" href="/blog/assets/js/39.d012b075.js"><link rel="prefetch" href="/blog/assets/js/4.85a42d17.js"><link rel="prefetch" href="/blog/assets/js/40.b67f9f4a.js"><link rel="prefetch" href="/blog/assets/js/41.ddec1210.js"><link rel="prefetch" href="/blog/assets/js/42.58d4c38b.js"><link rel="prefetch" href="/blog/assets/js/43.349e611a.js"><link rel="prefetch" href="/blog/assets/js/44.f327f050.js"><link rel="prefetch" href="/blog/assets/js/45.5b78689d.js"><link rel="prefetch" href="/blog/assets/js/46.c1d70453.js"><link rel="prefetch" href="/blog/assets/js/47.dfd780d0.js"><link rel="prefetch" href="/blog/assets/js/48.5743718f.js"><link rel="prefetch" href="/blog/assets/js/49.9ca593b1.js"><link rel="prefetch" href="/blog/assets/js/5.bc12a0a5.js"><link rel="prefetch" href="/blog/assets/js/50.39e017f0.js"><link rel="prefetch" href="/blog/assets/js/51.3c7e7718.js"><link rel="prefetch" href="/blog/assets/js/52.c183fd4d.js"><link rel="prefetch" href="/blog/assets/js/53.ea79a958.js"><link rel="prefetch" href="/blog/assets/js/54.e65f5d09.js"><link rel="prefetch" href="/blog/assets/js/55.8b1c97ea.js"><link rel="prefetch" href="/blog/assets/js/56.083e4ae1.js"><link rel="prefetch" href="/blog/assets/js/57.99344d20.js"><link rel="prefetch" href="/blog/assets/js/58.e4ce164d.js"><link rel="prefetch" href="/blog/assets/js/59.7b89f0b8.js"><link rel="prefetch" href="/blog/assets/js/6.aac072d7.js"><link rel="prefetch" href="/blog/assets/js/60.b4bd558a.js"><link rel="prefetch" href="/blog/assets/js/61.953c1ff1.js"><link rel="prefetch" href="/blog/assets/js/62.675b2c2d.js"><link rel="prefetch" href="/blog/assets/js/63.c7756200.js"><link rel="prefetch" href="/blog/assets/js/64.105f0255.js"><link rel="prefetch" href="/blog/assets/js/65.72dbc8b3.js"><link rel="prefetch" href="/blog/assets/js/66.33bf686a.js"><link rel="prefetch" href="/blog/assets/js/67.added4fb.js"><link rel="prefetch" href="/blog/assets/js/68.2d75999d.js"><link rel="prefetch" href="/blog/assets/js/69.789b2068.js"><link rel="prefetch" href="/blog/assets/js/7.598fcf35.js"><link rel="prefetch" href="/blog/assets/js/70.dc2938ec.js"><link rel="prefetch" href="/blog/assets/js/71.8978e5e2.js"><link rel="prefetch" href="/blog/assets/js/72.49706859.js"><link rel="prefetch" href="/blog/assets/js/73.c7f51aff.js"><link rel="prefetch" href="/blog/assets/js/74.e8b35b3e.js"><link rel="prefetch" href="/blog/assets/js/75.46e475b8.js"><link rel="prefetch" href="/blog/assets/js/76.2998707b.js"><link rel="prefetch" href="/blog/assets/js/77.a03bb11c.js"><link rel="prefetch" href="/blog/assets/js/78.9e21284f.js"><link rel="prefetch" href="/blog/assets/js/79.4d7c83db.js"><link rel="prefetch" href="/blog/assets/js/8.8f057574.js"><link rel="prefetch" href="/blog/assets/js/80.cbee4892.js"><link rel="prefetch" href="/blog/assets/js/81.dd90612f.js"><link rel="prefetch" href="/blog/assets/js/82.72a043ee.js"><link rel="prefetch" href="/blog/assets/js/83.218b78b0.js"><link rel="prefetch" href="/blog/assets/js/84.33752695.js"><link rel="prefetch" href="/blog/assets/js/85.c5bc3a64.js"><link rel="prefetch" href="/blog/assets/js/86.a8a4988e.js"><link rel="prefetch" href="/blog/assets/js/87.8bba3a3a.js"><link rel="prefetch" href="/blog/assets/js/88.4b136e7f.js"><link rel="prefetch" href="/blog/assets/js/89.77f04e86.js"><link rel="prefetch" href="/blog/assets/js/9.43c8ee0b.js"><link rel="prefetch" href="/blog/assets/js/90.2e4e24f9.js"><link rel="prefetch" href="/blog/assets/js/91.a474434d.js"><link rel="prefetch" href="/blog/assets/js/92.781278fb.js"><link rel="prefetch" href="/blog/assets/js/93.0651f3ab.js"><link rel="prefetch" href="/blog/assets/js/94.e8b9861b.js"><link rel="prefetch" href="/blog/assets/js/95.6987fefc.js"><link rel="prefetch" href="/blog/assets/js/96.a43fcfd0.js"><link rel="prefetch" href="/blog/assets/js/97.bca7af89.js"><link rel="prefetch" href="/blog/assets/js/98.cb17a28e.js"><link rel="prefetch" href="/blog/assets/js/99.2f912aba.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b3aba94c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述" class="sidebar-heading clickable"><span>Go类型系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述.html" class="sidebar-link">Go类型系统概述</a></li><li><a href="/blog/开发基础/GO/Go类型系统/2指针.html" class="sidebar-link">指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/3结构体.html" class="sidebar-link">结构体</a></li><li><a href="/blog/开发基础/GO/Go类型系统/4值部.html" class="sidebar-link">值部</a></li><li><a href="/blog/开发基础/GO/Go类型系统/5数组、切片和映射.html" class="sidebar-link">数组、切片和映射</a></li><li><a href="/blog/开发基础/GO/Go类型系统/6通道.html" class="sidebar-link">通道</a></li><li><a href="/blog/开发基础/GO/Go类型系统/7方法.html" class="sidebar-link">方法</a></li><li><a href="/blog/开发基础/GO/Go类型系统/8接口.html" class="sidebar-link">接口</a></li><li><a href="/blog/开发基础/GO/Go类型系统/9类型内嵌.html" class="sidebar-link">类型内嵌</a></li><li><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html" class="sidebar-link">非类型安全指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/11泛型.html" class="sidebar-link">泛型</a></li><li><a href="/blog/开发基础/GO/Go类型系统/12反射.html" class="sidebar-link">反射</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍" class="sidebar-heading clickable"><span>Go编程入门</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍.html" class="sidebar-link">程序源代码基本元素介绍</a></li><li><a href="/blog/开发基础/GO/Go编程入门/2关键字和标识符.html" class="sidebar-link">关键字和标识符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/3基本类型和它们的字面量表示.html" class="sidebar-link">基本类型和它们的字面量表示</a></li><li><a href="/blog/开发基础/GO/Go编程入门/4常量和变量.html" class="sidebar-link">常量和变量</a></li><li><a href="/blog/开发基础/GO/Go编程入门/5运算操作符.html" class="sidebar-link">运算操作符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/6函数声明和调用.html" class="sidebar-link">函数声明和调用</a></li><li><a href="/blog/开发基础/GO/Go编程入门/7代码包和包引入.html" class="sidebar-link">代码包和包引入</a></li><li><a href="/blog/开发基础/GO/Go编程入门/8表达式、语句和简单语句.html" class="sidebar-link">表达式、语句和简单语句</a></li><li><a href="/blog/开发基础/GO/Go编程入门/9基本流程控制语法.html" class="sidebar-link">基本流程控制语法</a></li><li><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html" class="sidebar-link">协程、延迟函数调用、以及恐慌和恢复</a></li><li><a href="/blog/开发基础/GO/Go编程入门/GO官方链接工具.html" class="sidebar-link">GO官方链接工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/其他文章/Go技巧" class="sidebar-heading clickable"><span>其他文章</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/其他文章/Go技巧.html" class="sidebar-link">Go技巧</a></li><li><a href="/blog/开发基础/GO/其他文章/Go细节.html" class="sidebar-link">Go细节</a></li><li><a href="/blog/开发基础/GO/其他文章/Go问答.html" class="sidebar-link">Go问答</a></li><li><a href="/blog/开发基础/GO/其他文章/命令-mod.html" class="sidebar-link">命令-mod</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Golang的time.NewTimer单次定时器使用案例.html" class="sidebar-link">基础-Golang的time. NewTimer单次定时器使用案例</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go中的nil.html" class="sidebar-link">Go中的 nil</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go代码断行规则.html" class="sidebar-link">Go代码断行规则</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-表达式估值顺序规则.html" class="sidebar-link">表达式估值顺序规则</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/学习资料" class="sidebar-heading clickable"><span>GO</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/学习资料.html" class="sidebar-link">教学书籍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/并发编程/1并发同步概述" class="sidebar-heading clickable open"><span>并发编程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/并发编程/1并发同步概述.html" class="sidebar-link">并发同步概述</a></li><li><a href="/blog/开发基础/GO/并发编程/2通道用例大全.html" class="sidebar-link">通道用例大全</a></li><li><a href="/blog/开发基础/GO/并发编程/3如何优雅地关闭通道.html" class="sidebar-link">如何优雅地关闭通道</a></li><li><a href="/blog/开发基础/GO/并发编程/4其它并发同步技术.html" class="sidebar-link">sync 标准库包中提供的并发同步技术</a></li><li><a href="/blog/开发基础/GO/并发编程/5原子操作 .html" class="sidebar-link">sync/atomic 标准库包中提供的原子操作</a></li><li><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html" class="active sidebar-link">Go中的内存顺序保证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#关于内存顺序" class="sidebar-link">关于内存顺序</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#go内存模型-memory-model" class="sidebar-link">Go内存模型（Memory Model）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#一个协程的创建发生在此协程中的任何代码执行之前" class="sidebar-link">一个协程的创建发生在此协程中的任何代码执行之前</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#通道操作相关的顺序保证" class="sidebar-link">通道操作相关的顺序保证</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#互斥锁相关的顺序保证" class="sidebar-link">互斥锁相关的顺序保证</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#sync-waitgroup-值做出的顺序保证" class="sidebar-link">sync. WaitGroup 值做出的顺序保证</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#sync-once-值做出的顺序保证" class="sidebar-link">sync. Once 值做出的顺序保证</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#sync-cond-值做出的顺序保证" class="sidebar-link">sync. Cond 值做出的顺序保证</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html#原子操作相关的顺序保证" class="sidebar-link">原子操作相关的顺序保证</a></li></ul></li></ul></li><li><a href="/blog/开发基础/GO/并发编程/7一些常见并发编程错误.html" class="sidebar-link">一些常见并发编程错误</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境" class="sidebar-heading clickable"><span>开发环境搭建</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境.html" class="sidebar-link">Docker和VS Code的Go开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="go中的内存顺序保证"><a href="#go中的内存顺序保证" class="header-anchor">#</a> Go中的内存顺序保证</h1> <h2 id="关于内存顺序"><a href="#关于内存顺序" class="header-anchor">#</a> 关于内存顺序</h2> <p>很多编译器优化（在编译时刻）和CPU处理器优化（在运行时刻）会常常调整指令执行顺序，从而使得指令执行顺序和代码中指定的顺序不太一致。 指令顺序也称为<a href="https://en.wikipedia.org/wiki/Memory_ordering" target="_blank" rel="noopener noreferrer">内存顺序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>当然，指令执行顺序的调整规则不是任意的。 最基本的要求是发生在一个不与其它协程共享数据的协程内部的指令执行顺序调整在此协程内部必须不能被觉察到。 换句话说，从这样的一个协程的角度看，其中的指令执行顺序和代码中指定的顺序总是一致的，即使确实有一些指令的执行顺序发生了调整。</p> <p>然而，如果一些协程之间共享数据，那么在其中一个协程中发生的指令执行顺序调整将有可能被剩余的其它协程觉察到，从而影响到所有这些协程的行为。 在并发编程中，多个协程之间共享数据是家常便饭。 如果我们忽视了指令执行顺序调整带来的影响，我们编写的并发程序的行为将依赖于特定编译器和CPU。这样的程序常常表现出异常行为。</p> <p>下面是一个编写得非常不职业的Go程序。此程序的编写没有考虑指令执行顺序调整带来的影响。 此程序扩展于官方文档<a href="https://golang.google.cn/ref/mem" target="_blank" rel="noopener noreferrer">Go 1 内存模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文中的一个例子.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;log&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;runtime&quot;</span>

<span class="token keyword">var</span> a <span class="token builtin">string</span>
<span class="token keyword">var</span> done <span class="token builtin">bool</span>

<span class="token keyword">func</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">=</span> <span class="token string">&quot;hello, world&quot;</span>
	done <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> done <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 如果被打印出来，它总是12</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
		runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 期待的打印结果：hello, world</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此程序的行为很可能正如我们所料， <code>hello, world</code> 将被打印输出。 然而，此程序的行为并非跨编译器和跨平台架构兼容的。 如果此程序使用一个不同的（但符合Go规范的）编译器或者不同的编译器版本编译，它的运行结果可能是不同的。 即使此程序使用同一个编译器编译，在不同的平台架构上的运行结果也可能是不同的。</p> <p>编译器和CPU可能调整 <code>setup</code> 函数中的前两条语句的执行顺序，使得 <code>setup</code> 协程中的指令的执行顺序和下面的代码指定的顺序一致。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	done <span class="token operator">=</span> <span class="token boolean">true</span>
	a <span class="token operator">=</span> <span class="token string">&quot;hello, world&quot;</span>
	<span class="token keyword">if</span> done <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>setup</code> 协程并不会觉察到此执行顺序调整，所以此协程中的 <code>log. Println(len(a))</code> 语句将总是打印出 <code>12</code> （如果此打印语句在程序退出之前得到了执行的话）。 但是，此执行顺序调整将被主协程觉察到，所以最终的打印结果有可能是空，而不是 <code>hello, world</code> 。</p> <p>除了没有考虑指令执行顺序调整带来的影响，此程序还存在数据竞争的问题。 变量 <code>a</code> 和 <code>done</code> 的使用没有进行同步。 所以此程序是一个充满了各种并发编程错误的不良例子。 一个职业的Go程序员不应该写出这样的使用于生产环境中的代码。</p> <p>我们可以使用Go官方工具链中的 <code>go build -race</code> 命令来编译并运行一个程序，以检查此程序中是否存在着数据竞争。</p> <h2 id="go内存模型-memory-model"><a href="#go内存模型-memory-model" class="header-anchor">#</a> Go内存模型（Memory Model）</h2> <p>有时，为了程序的逻辑正确性，我们需要确保一个协程中的一些语句一定要在另一个协程的某些语句之后（或者之前）执行（从这两个协程的角度观察都是如此）。 指令执行顺序调整可能会给此需求带来一些麻烦。 我们应如何防止某些可能发生的指令执行顺序调整呢？</p> <p>不同的CPU架构提供了不同的栅栏（fence）指令来防止各种指令执行顺序调整。 一些编程语言提供对应的函数来在代码中的合适位置插入各种栅栏指令。 但是，理解和正确地使用这些栅栏指令极大地提高了并发编程的门槛。</p> <p>Go语言的设计哲学是用尽量少的易于理解的特性来支持尽量多的使用场景，同时还要尽量保证代码的高执行效率。 所以Go内置和标准库并没有提供直接插入各种栅栏指令的途径。 事实上，这些栅栏指令被使用在Go中提供的各种高级数据同步技术的实现中。 所以，我们应该使用Go中提供的高级数据同步技术来保证我们所期待的代码执行顺序。</p> <p>本文的余下部分将列出Go中保证的各种代码执行顺序。 这些顺序保证可能在<a href="https://golang.google.cn/ref/mem" target="_blank" rel="noopener noreferrer">Go 1 内存模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文提到了，也可能没有提到。</p> <p>在下面的叙述中，如果我们说事件 <code>A</code> 保证发生在事件 <code>B</code> 之前，这意味着这两个事件涉及到的任何协程都将观察到在事件 <code>A</code> 之前的语句肯定将在事件 <code>B</code> 之后的语句先执行。 对于不相关的协程，它们所观察到的顺序可能并非如此所述。</p> <h3 id="一个协程的创建发生在此协程中的任何代码执行之前"><a href="#一个协程的创建发生在此协程中的任何代码执行之前" class="header-anchor">#</a> 一个协程的创建发生在此协程中的任何代码执行之前</h3> <p>在下面这个函数中，对 <code>x</code> 和 <code>y</code> 的赋值保证发生在对它们的打印之前，并且对 <code>x</code> 的打印肯定发生在对 <code>y</code> 的打印之前。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">789</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然而这些顺序在下面这个函数中是得不到任何保证的。此函数存在着数据竞争。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// 可能打印出0、123，或其它值</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token comment">// 可能打印出0、789，或其它值</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">789</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="通道操作相关的顺序保证"><a href="#通道操作相关的顺序保证" class="header-anchor">#</a> 通道操作相关的顺序保证</h3> <p>下面列出的是通道操作做出的基本顺序保证：</p> <ol><li>一个通道上的第***n*<strong>次成功发送操作的开始发生在此通道上的第</strong>*n***次成功接收操作完成之前，无论此通道是缓冲的还是非缓冲的。</li> <li>一个容量为***m*<strong>通道上的第</strong>*n*<strong>次成功接收操作的开始发生在此通道上的第</strong>*n+m*<strong>次发送操作完成之前。 特别地，如果此通道是非缓冲的（<code>m == 0</code>），则此通道上的第</strong>*n*<strong>次成功接收操作的开始发生在此通道上的第</strong>*n***次发送操作完成之前。</li> <li>一个通道的关闭操作发生在任何因为此通道被关闭而从此通道接收到了零值的操作完成之前。</li></ol> <p>事实上， 对一个非缓冲通道来说，其上的第***n*<strong>次成功发送的完成的发送和其上的第</strong>*n***次成功接收的完成应被视为同一事件。</p> <p>下面这段代码展示了一个非缓冲通道上的发送和接收操作是如何保证特定的代码执行顺序的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span>
	<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		a <span class="token operator">=</span> <span class="token number">1</span>
		c <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		<span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;b != 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 绝不可能发生</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token operator">&lt;-</span>c
		<span class="token keyword">if</span> a <span class="token operator">!=</span> <span class="token number">1</span>  <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;a != 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 绝不可能发生</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于函数 <code>f3</code> 中创建的两个协程，下列顺序将得到保证：</p> <ul><li>赋值语句<code>b = 1</code>肯定在条件<code>b != 1</code>被估值之前执行完毕。</li> <li>赋值语句<code>a = 1</code>肯定在条件<code>a != 1</code>被估值之前执行完毕。</li></ul> <p>所以，上例代码中两个协程中的 <code>panic</code> 调用将永不可能得到执行。 做为对比，下面这段代码中的 <code>panic</code> 调用有可能会得到执行，因为上述通道操作相关的顺序保证对于不相关的协程是无效的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		a <span class="token operator">=</span> <span class="token number">1</span>
		c <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		x <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		b <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token operator">&lt;-</span>c
		y <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 一个和上面的通道操作不相关的协程。</span>
	<span class="token comment">// 这是一个不良代码的例子，它造成了很多数据竞争。</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> a <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;a != 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 有可能发生</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;b != 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 有可能发生</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> y <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> a <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;a != 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 有可能发生</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;b != 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 有可能发生</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的新创建的第三个协程是一个和通道 <code>c</code> 上的发送和接收操作不相关的一个协程。 它所观察到的执行顺序和其它两个新创建的协程可能是不同的。 条件 <code>a != 1</code> 和 <code>b != 1</code> 的估值有可能为 <code>true</code> ，所以四个 <code>panic</code> 调用有可能会得到执行。</p> <p>事实上，大多数编译器的实现确实很可能能够保证上面这个不良的例子中的四个 <code>panic</code> 调用永远不可能被执行，但是，没有任何Go官方文档做出了这样的保证。 此不良例子的执行结果是依赖于不同的编译器和不同的编译器版本的。 我们编写的Go代码应该以Go官方文档中明确记录下来的规则为依据。</p> <p>下面是一个缓冲通道的例子。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		k <span class="token operator">=</span> <span class="token number">1</span>
		c <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		l <span class="token operator">=</span> <span class="token number">1</span>
		c <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		m <span class="token operator">=</span> <span class="token number">1</span>
		c <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		n <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		x <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token operator">&lt;-</span>c
		y <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在此例子中，下面的顺序得以保证：</p> <ul><li>赋值语句<code>k = 1</code>的执行保证在赋值语句<code>y = 1</code>的执行之前结束。</li> <li>赋值语句<code>x = 1</code>的执行保证在赋值语句<code>n = 1</code>的执行之前结束。</li></ul> <p>然而，赋值语句 <code>x = 1</code> 的执行并不能保证在赋值语句 <code>l = 1</code> 和 <code>m = 1</code> 的执行之前结束， 赋值语句 <code>l = 1</code> 和 <code>m = 1</code> 的执行也不能保证在赋值语句 <code>y = 1</code> 的执行之前结束。</p> <p>下面是一个通道关闭的例子。在这个例子中，赋值语句 <code>k = 1</code> 的执行保证在赋值语句 <code>y = 1</code> 执行之前结束，但不能保证在赋值语句 <code>x = 1</code> 执行之前结束。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> k<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		k <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">&lt;-</span>c
		x <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token operator">&lt;-</span>c
		y <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="互斥锁相关的顺序保证"><a href="#互斥锁相关的顺序保证" class="header-anchor">#</a> 互斥锁相关的顺序保证</h3> <p>Go中和<a href="https://gfw.go101.org/article/concurrent-synchronization-more.html#mutex" target="_blank" rel="noopener noreferrer">互斥锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>相关的顺序保证：</p> <ol><li>对于一个可寻址的<code>sync.Mutex</code>类型或者<code>sync.RWMutex</code>类型的值<code>m</code>，第***n*<strong>次成功的<code>m.Unlock()</code>方法调用保证发生在第</strong>*n+1***次<code>m.Lock()</code>方法调用返回之前。</li> <li>对一个可寻址的<code>RWMutex</code>类型值<code>rw</code>，如果它的第***n*<strong>次<code>rw.Lock()</code>方法调用已成功返回，并且有一个<code>rw.RLock()</code>方法调用保证发生在此第</strong>*n*<strong>次<code>rw.Lock()</code>方法调用返回之后，则第</strong>*n***次成功的<code>rw.Unlock()</code>方法调用保证发生在此<code>rw.RLock()</code>方法调用返回之前。</li> <li>对一个可寻址的<code>RWMutex</code>类型值<code>rw</code>，如果它的第***n*<strong>次<code>rw.RLock()</code>方法调用已成功返回，并且有一个<code>rw.Lock()</code>方法调用保证发生在此第</strong>*n*<strong>次<code>rw.RLock()</code>方法调用返回之后，则第</strong>*m***次成功的<code>rw.RUnlock()</code>方法调用（其中<code>m &lt;= n</code>）保证发生在此<code>rw.Lock()</code>方法调用返回之前。</li></ol> <p>在下面这个例子中，下列顺序肯定得到保证。</p> <ul><li>赋值语句<code>a = 1</code>的执行保证在赋值语句<code>b = 1</code>的执行之前结束。</li> <li>赋值语句<code>m = 1</code>的执行保证在赋值语句<code>n = 1</code>的执行之前结束。</li> <li>赋值语句<code>x = 1</code>的执行保证在赋值语句<code>y = 1</code>的执行之前结束。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">fab</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span>
	<span class="token keyword">var</span> l sync<span class="token punctuation">.</span>Mutex <span class="token comment">// or sync.RWMutex</span>

	l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		b <span class="token operator">=</span> <span class="token number">1</span>
		l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		a <span class="token operator">=</span> <span class="token number">1</span>
		l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">fmn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> m<span class="token punctuation">,</span> n <span class="token builtin">int</span>
	<span class="token keyword">var</span> l sync<span class="token punctuation">.</span>RWMutex

	l<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		n <span class="token operator">=</span> <span class="token number">1</span>
		l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		m <span class="token operator">=</span> <span class="token number">1</span>
		l<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">fxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
	<span class="token keyword">var</span> l sync<span class="token punctuation">.</span>RWMutex

	l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		l<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		y <span class="token operator">=</span> <span class="token number">1</span>
		l<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		x <span class="token operator">=</span> <span class="token number">1</span>
		l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意，在下面这段代码中，根据Go官方文档，赋值语句 <code>p = 1</code> 的执行并不能保证在赋值语句 <code>q = 1</code> 的执行之前结束，尽管多数编译器确实能够做出这样的保证。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> p<span class="token punctuation">,</span> q <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">fpq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> l sync<span class="token punctuation">.</span>Mutex
	p <span class="token operator">=</span> <span class="token number">1</span>
	l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	q <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="sync-waitgroup-值做出的顺序保证"><a href="#sync-waitgroup-值做出的顺序保证" class="header-anchor">#</a> <code>sync. WaitGroup</code> 值做出的顺序保证</h3> <p>假设在某个给定时刻，一个可寻址的 <code>sync. WaitGroup</code> 值 <code>wg</code> 维护的计数不为0，并且有一个 <code>wg. Wait()</code> 方法调用在此给定时刻之后调用。 如果有一组 <code>wg. Add(n)</code> 方法调用在此给定时刻之后调用，并且我们可以保证这组调用中只有最后一个返回的调用会将 <code>wg</code> 维护的计数修改为0， 则这组调用中的每个调用保证都发生在此 <code>wg. Wait()</code> 方法调用返回之前。</p> <p>注意：调用 <code>wg. Done()</code> 和 <code>wg. Add(-1)</code> 是等价的。</p> <p>请阅读<a href="https://gfw.go101.org/article/concurrent-synchronization-more.html#waitgroup" target="_blank" rel="noopener noreferrer">对 <code>sync. WaitGroup</code> 类型的解释<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来获取如何使用 <code>sync. WaitGroup</code> 值。</p> <h3 id="sync-once-值做出的顺序保证"><a href="#sync-once-值做出的顺序保证" class="header-anchor">#</a> <code>sync. Once</code> 值做出的顺序保证</h3> <p>请阅读<a href="https://gfw.go101.org/article/concurrent-synchronization-more.html#once" target="_blank" rel="noopener noreferrer">对 <code>sync. Once</code> 类型的解释<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来获取 <code>sync. Once</code> 值做出的顺序保证和如何使用 <code>sync. Once</code> 值。</p> <h3 id="sync-cond-值做出的顺序保证"><a href="#sync-cond-值做出的顺序保证" class="header-anchor">#</a> <code>sync. Cond</code> 值做出的顺序保证</h3> <p><code>sync. Cond</code> 值出的顺序保证有些难以表达清楚。所以这里就只可意会不可言传了。 请阅读<a href="https://gfw.go101.org/article/concurrent-synchronization-more.html#cond" target="_blank" rel="noopener noreferrer">对 <code>sync. Cond</code> 类型的解释<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来获取如何使用 <code>sync. Cond</code> 值。</p> <h3 id="原子操作相关的顺序保证"><a href="#原子操作相关的顺序保证" class="header-anchor">#</a> 原子操作相关的顺序保证</h3> <p>没有任何官方文档提到了原子操作所保证的内存顺序。 然而，事实上，对于标准编译器来说，原子操作确实保证了某些特定的内存顺序。 标准库的实现大量地依赖于这些原子操作做出的内存顺序保证。</p> <p>下面这个程序如果使用标准编译器1.16编译的话，它在运行时肯定打印出 <code>1</code> 。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;sync/atomic&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;runtime&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> n <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在此程序中，主协程总是会观察到对 <code>a</code> 的修改在对 <code>b</code> 的修改之前结束。 但是，这种保证没有记录在任何Go官方文档中。 如果你希望你编写的Go代码能够跨编译器和跨编译器版本兼容，那么安全的建议是<strong>不要依赖于原子操作做出的内存顺序保证</strong>。 有<a href="https://github.com/golang/go/issues/5045" target="_blank" rel="noopener noreferrer">一个issue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>建议Go官方文档将目前原子操作做出的内存顺序保证记录下来。 但是到目前为止（Go 1.16），此建议还未被采纳。</p> <p>请阅读<a href="https://gfw.go101.org/article/concurrent-atomic-operation.html" target="_blank" rel="noopener noreferrer">原子操作<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文来获取如何使用原子操作。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/开发基础/GO/并发编程/5原子操作 .html" class="prev">
        sync/atomic 标准库包中提供的原子操作
      </a></span> <span class="next"><a href="/blog/开发基础/GO/并发编程/7一些常见并发编程错误.html">
        一些常见并发编程错误
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.402a9c30.js" defer></script><script src="/blog/assets/js/3.64b046d0.js" defer></script><script src="/blog/assets/js/118.75c62650.js" defer></script>
  </body>
</html>
